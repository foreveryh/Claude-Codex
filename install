#!/bin/bash

# ============================================
# Claude-Codex 统一安装入口
# ============================================
#
# 用途：引导用户选择合适的安装方式
#       - 全局安装：User Scope，配置一次处处可用
#       - 项目安装：Project Scope，配置可版本控制
#
# 使用方法：
#   # 本地执行
#   ./install
#
#   # 远程执行
#   bash <(curl -sSL https://raw.githubusercontent.com/.../install)
# ============================================

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# GitHub 仓库信息
REPO_URL="https://raw.githubusercontent.com/foreveryh/Claude-Codex/main"

# 检测脚本是本地执行还是远程执行
detect_execution_mode() {
    if [ -f "./install-global.sh" ] && [ -f "./install-project.sh" ]; then
        echo "local"
    else
        echo "remote"
    fi
}

# 本地执行脚本
execute_local() {
    local script=$1
    if [ ! -f "./$script" ]; then
        echo -e "${RED}错误：找不到脚本 ./$script${NC}"
        exit 1
    fi
    bash "./$script"
}

# 远程执行脚本
execute_remote() {
    local script=$1
    echo -e "${CYAN}正在从 GitHub 下载脚本...${NC}"
    bash <(curl -sSL "${REPO_URL}/${script}")
}

# 执行安装脚本
execute_script() {
    local script=$1
    local mode=$(detect_execution_mode)

    if [ "$mode" = "local" ]; then
        execute_local "$script"
    else
        execute_remote "$script"
    fi
}

# 显示欢迎界面
show_welcome() {
    clear
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║                                                    ║${NC}"
    echo -e "${BLUE}║          ${GREEN}Claude-Codex 安装向导${BLUE}                 ║${NC}"
    echo -e "${BLUE}║                                                    ║${NC}"
    echo -e "${BLUE}║     ${CYAN}AI 驱动的代码协作开发环境${BLUE}                  ║${NC}"
    echo -e "${BLUE}║                                                    ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# 显示安装选项
show_options() {
    echo -e "${YELLOW}请选择安装方式：${NC}"
    echo ""
    echo -e "  ${GREEN}[1]${NC} ${CYAN}全局安装${NC} ${GREEN}(推荐 ⭐)${NC}"
    echo -e "      ${BLUE}→${NC} 配置一次，所有项目可用"
    echo -e "      ${BLUE}→${NC} 适合个人开发者"
    echo -e "      ${BLUE}→${NC} User Scope（内部管理）"
    echo ""
    echo -e "  ${GREEN}[2]${NC} ${CYAN}项目安装${NC}"
    echo -e "      ${BLUE}→${NC} 配置写入 .mcp.json"
    echo -e "      ${BLUE}→${NC} 适合团队协作，可版本控制"
    echo -e "      ${BLUE}→${NC} Project Scope（可见文件）"
    echo ""
    echo -e "  ${GREEN}[3]${NC} ${CYAN}快速初始化${NC}"
    echo -e "      ${BLUE}→${NC} 仅创建工作目录（需已有全局配置）"
    echo -e "      ${BLUE}→${NC} 1 秒完成，无需安装"
    echo ""
    echo -e "  ${GREEN}[q]${NC} 退出"
    echo ""
}

# 显示帮助信息
show_help() {
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}📚 使用场景说明${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${GREEN}👤 个人开发者${NC}"
    echo "   → 选择 [1] 全局安装"
    echo "   → 配置后，在任何项目中运行 'claude' 即可使用"
    echo ""
    echo -e "${GREEN}👥 团队协作${NC}"
    echo "   → 选择 [2] 项目安装"
    echo "   → 生成 .mcp.json，提交到 Git，团队成员自动生效"
    echo ""
    echo -e "${GREEN}⚡ 快速体验${NC}"
    echo "   → 先选择 [1] 全局安装"
    echo "   → 以后新项目直接选择 [3] 快速初始化"
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

# 主函数
main() {
    show_welcome
    show_help
    show_options

    # 读取用户选择
    while true; do
        read -p "$(echo -e ${CYAN}请选择 [1/2/3/q]: ${NC})" choice

        case $choice in
            1)
                echo ""
                echo -e "${GREEN}✓${NC} 开始全局安装..."
                echo ""
                execute_script "install-global.sh"
                break
                ;;
            2)
                echo ""
                echo -e "${GREEN}✓${NC} 开始项目安装..."
                echo ""
                execute_script "install-project.sh"
                break
                ;;
            3)
                echo ""
                echo -e "${GREEN}✓${NC} 快速初始化工作目录..."
                echo ""
                execute_script "init-workspace.sh"
                break
                ;;
            q|Q)
                echo ""
                echo -e "${YELLOW}已取消安装${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}无效选择，请输入 1, 2, 3 或 q${NC}"
                ;;
        esac
    done

    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✨ 安装完成！${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${CYAN}下一步：${NC}"

    if [ "$choice" = "1" ]; then
        echo "  1. 运行 'claude mcp list' 验证配置"
        echo "  2. 在任何项目中运行 'claude' 开始使用"
    elif [ "$choice" = "2" ]; then
        echo "  1. 运行 'claude mcp list' 验证配置"
        echo "  2. 将 .mcp.json 提交到 Git（团队协作）"
        echo "  3. 运行 'claude' 开始使用"
    else
        echo "  1. 运行 'claude' 开始使用"
    fi

    echo ""
    echo -e "${CYAN}📖 更多文档：${NC}"
    echo "  - 使用指南: https://github.com/foreveryh/Claude-Codex/blob/main/USAGE-GUIDE.md"
    echo "  - 故障排除: https://github.com/foreveryh/Claude-Codex/blob/main/troubleshooting.md"
    echo ""
}

# 执行主函数
main "$@"
