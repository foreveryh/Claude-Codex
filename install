#!/bin/bash

# ============================================
# Claude-Codex 一键安装脚本（支持远程执行）
# ============================================
#
# 本地执行：
#   ./install
#
# 远程执行（推荐）：
#   bash <(curl -sSL https://raw.githubusercontent.com/foreveryh/Claude-Codex/main/install)
#
# ============================================

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# GitHub 仓库信息
GITHUB_USER="foreveryh"
GITHUB_REPO="Claude-Codex"
GITHUB_BRANCH="main"
RAW_URL="https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/$GITHUB_BRANCH"

# 临时目录
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# 打印函数
print_header() {
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║   Claude Code + Codex 一键安装向导     ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

# 检测执行模式
detect_mode() {
    if [ -f "./install.sh" ] && [ -d "./.claude/skills/codex-workflow" ]; then
        echo "local"
    else
        echo "remote"
    fi
}

# 下载文件
download_file() {
    local url=$1
    local output=$2

    if command -v curl >/dev/null 2>&1; then
        curl -sSL "$url" -o "$output"
    elif command -v wget >/dev/null 2>&1; then
        wget -q "$url" -O "$output"
    else
        print_error "需要 curl 或 wget 来下载文件"
        exit 1
    fi
}

# 远程安装模式
remote_install() {
    print_info "检测到远程执行模式，正在下载安装脚本..."
    echo ""

    # 下载主安装脚本
    local install_script="$TEMP_DIR/install.sh"
    download_file "$RAW_URL/install.sh" "$install_script"
    chmod +x "$install_script"
    print_success "下载 install.sh"

    # 创建 Skill 目录结构
    mkdir -p "$TEMP_DIR/.claude/skills/codex-workflow/templates"

    # 下载 Skill 文件
    print_info "下载 Codex Workflow Skill..."
    download_file "$RAW_URL/.claude/skills/codex-workflow/SKILL.md" \
                  "$TEMP_DIR/.claude/skills/codex-workflow/SKILL.md"
    print_success "SKILL.md"

    download_file "$RAW_URL/.claude/skills/codex-workflow/README.md" \
                  "$TEMP_DIR/.claude/skills/codex-workflow/README.md" 2>/dev/null || true

    # 下载模板文件
    local templates=(
        "task-marker-format.txt"
        "codex-prompt-template.md"
        "context-initial-template.json"
        "review-checklist.md"
        "skill-troubleshooting.md"
    )

    for template in "${templates[@]}"; do
        download_file "$RAW_URL/.claude/skills/codex-workflow/templates/$template" \
                      "$TEMP_DIR/.claude/skills/codex-workflow/templates/$template"
        print_success "templates/$template"
    done

    echo ""
    print_success "所有文件下载完成"
    echo ""

    # 执行安装脚本
    cd "$TEMP_DIR"
    bash "$install_script"
}

# 本地安装模式
local_install() {
    print_info "检测到本地执行模式"
    echo ""

    if [ ! -f "./install.sh" ]; then
        print_error "找不到 install.sh 脚本"
        exit 1
    fi

    bash "./install.sh"
}

# 主函数
main() {
    print_header

    local mode=$(detect_mode)

    if [ "$mode" = "remote" ]; then
        remote_install
    else
        local_install
    fi
}

# 运行主函数
main "$@"
