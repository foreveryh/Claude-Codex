# Codex 调用提示模板

## 模板1：上下文收集（初次调用）

```
[TASK_MARKER: {YYYYMMDD-HHMMSS-XXXX}]

目标：结构化快速扫描，收集 {任务描述} 相关的所有上下文

具体要求：
1. 扫描范围：{指定目录或模块，如 src/auth/, src/utils/}
2. 关注点：{如：认证逻辑、数据库操作、API端点等}
3. 查找相似案例：{如：已有的类似功能实现}

交付物：
输出到 `.claude/context-initial.json`，必须包含以下字段：

{
  "scan_type": "initial",
  "timestamp": "{ISO8601时间戳}",
  "project_location": "功能所在的具体模块/文件路径",
  "current_implementation": "现有实现方式的详细描述和关键代码片段",
  "similar_cases": ["相似案例1的路径和说明", "相似案例2的路径和说明"],
  "tech_stack": ["框架", "库", "工具", "语言版本"],
  "testing_info": "现有测试文件位置和测试方式",
  "observations": {
    "anomalies": ["发现的代码异常或潜在问题"],
    "info_gaps": ["信息不足或需要进一步调查的地方"],
    "suggestions": ["建议深入调查的方向"],
    "risks": ["识别的技术风险或架构风险"]
  }
}

时间分配：充分时间进行全面且深入的代码库扫描，不要急于完成
```

---

## 模板2：深度问题分析（继续会话）

```
基于 `.claude/context-initial.json` 的分析结果，我需要深入了解：

问题：{具体的问题描述}

分析要求：
1. 使用 sequential-thinking 进行深度推理
2. 查找相关代码实现
3. 分析不同方案的优劣
4. 评估实现复杂度和风险

交付物：
输出到 `.claude/context-question-{N}.json`，包含：

{
  "question_id": "question-{N}",
  "target_question": "{要解决的具体问题}",
  "analysis_depth": "deep",
  "evidence": [
    "代码片段1: {路径:行号} - {说明}",
    "代码片段2: {路径:行号} - {说明}"
  ],
  "conclusions": [
    "结论1：{详细说明}",
    "结论2：{详细说明}"
  ],
  "recommendations": [
    "建议1：{具体行动建议}",
    "建议2：{具体行动建议}"
  ],
  "timestamp": "{ISO8601时间戳}"
}
```

---

## 模板3：复杂算法设计（继续会话）

```
任务：设计并实现 {算法/功能描述}

输入：
- 上下文：`.claude/context-initial.json` 和 `.claude/context-question-*.json`
- 需求：{详细的功能需求}
- 约束：{性能要求、兼容性要求等}

设计要求：
1. 算法时间复杂度：{如 O(n log n) 以内}
2. 代码规范：{遵循项目现有风格}
3. 测试覆盖：{提供测试用例}
4. 错误处理：{完善的异常处理}

交付物：
1. 算法设计文档（伪代码或流程图）
2. 完整的代码实现
3. 单元测试代码
4. 使用示例

输出到：`.claude/codex/design-{TASK_MARKER}.md`
```

---

## 模板4：代码质量审查（新会话）

```
[TASK_MARKER: {同原任务的MARKER}]

任务：使用 sequential-thinking 进行深度代码审查

审查文件：
{列出所有修改的文件及行号范围}
- src/auth/login.ts (lines 45-120)
- src/utils/validation.ts (lines 20-55)

审查维度：

### 1. 技术维度（50分）
- [ ] 代码质量（20分）：可读性、可维护性、复杂度
- [ ] 测试覆盖（15分）：单元测试、集成测试、边界测试
- [ ] 规范遵循（15分）：编码规范、命名规范、注释规范

### 2. 战略维度（50分）
- [ ] 需求匹配（20分）：是否完整实现用户需求
- [ ] 架构一致（15分）：是否符合现有架构模式
- [ ] 风险评估（15分）：性能、安全、兼容性风险

交付物：
输出到 `.claude/review-report.md`，必须包含：

# 代码审查报告

## 元数据
- 审查时间：{时间}
- 审查者：Codex (sequential-thinking)
- 任务ID：{TASK_MARKER}

## 评分详情
- 技术维度：{分数}/50
  - 代码质量：{分数}/20
  - 测试覆盖：{分数}/15
  - 规范遵循：{分数}/15
- 战略维度：{分数}/50
  - 需求匹配：{分数}/20
  - 架构一致：{分数}/15
  - 风险评估：{分数}/15
- **综合评分**：{总分}/100

## 明确建议
【通过 / 退回 / 需讨论】

理由：{详细说明}

## 核对清单结果
- [x] 需求字段完整性
- [x] 代码质量标准
- [ ] 测试覆盖完整
- [x] 错误处理健全
- [ ] 文档更新完整

## 发现的问题
### 严重问题（必须修复）
1. {问题描述} - 位置：{文件:行号}

### 建议优化（可选）
1. {建议描述} - 位置：{文件:行号}

## 风险与阻塞
- 风险1：{描述} - 缓解方案：{建议}
- 阻塞问题1：{描述} - 解决方案：{建议}

## 支持论据
1. {论据1}：{详细说明和代码证据}
2. {论据2}：{详细说明和代码证据}
```

---

## 使用注意事项

### 1. Task Marker 管理
- 首次调用时生成新的 marker
- 继续会话使用 conversationId，不需要再加 marker
- 审查时使用原任务的 marker 以保持关联

### 2. 文件路径规范
- 所有输出文件必须在 `.claude/` 目录下
- 使用相对于项目根目录的路径
- 文件名包含 task marker 便于追溯

### 3. 时间戳格式
统一使用 ISO 8601 格式：
```
2025-11-12T14:30:25Z        # UTC时间
2025-11-12T14:30:25+08:00   # 东八区时间
```

### 4. JSON 输出质量
- 所有必填字段必须有值
- 数组不能为空（至少一个元素）
- 字符串不能是 "TODO" 或 "N/A"

### 5. 错误处理
如果 Codex 调用失败：
- 记录错误到 `.claude/logs/error-{MARKER}.log`
- 降级为主AI独立完成
- 在 operations-log.md 中记录决策

---

## 变量替换说明

在使用模板时，替换以下占位符：

| 占位符 | 说明 | 示例 |
|--------|------|------|
| `{YYYYMMDD-HHMMSS-XXXX}` | Task Marker | `20251112-143025-0001` |
| `{任务描述}` | 简洁的任务说明 | `重构用户登录逻辑` |
| `{指定目录或模块}` | 扫描范围 | `src/auth/, tests/auth/` |
| `{ISO8601时间戳}` | 时间戳 | `2025-11-12T14:30:25Z` |
| `{N}` | 问题编号 | `1`, `2`, `3` |
| `{文件:行号}` | 代码位置 | `src/auth/login.ts:67` |
| `{conversationId}` | Codex会话ID | `conv-abc123xyz` |

---

**遵循这些模板，确保 Codex 调用的一致性和高质量输出！**
