# 代码审查清单

## 📋 使用说明

此清单用于 Codex 进行代码质量审查时使用。每个检查项都有：
- 检查标准
- 评分权重
- 常见问题示例
- 检查方法

---

## 🎯 技术维度（50分）

### 1. 代码质量（20分）

#### 1.1 可读性（8分）
- [ ] **变量命名清晰**（2分）
  - 使用有意义的名称
  - 遵循命名规范（camelCase, PascalCase, snake_case等）
  - 避免单字母变量（除了循环变量 i, j, k）
  - 布尔变量使用 is/has/can 前缀

- [ ] **函数职责单一**（3分）
  - 每个函数只做一件事
  - 函数长度 <50 行
  - 参数数量 ≤5 个
  - 避免嵌套深度 >3 层

- [ ] **代码结构清晰**（3分）
  - 逻辑分组合理
  - 适当的空行和缩进
  - 相关代码放在一起
  - 导入语句有序组织

**常见问题：**
```javascript
// ❌ 差的命名
const d = new Date();
const f = (x) => x * 2;

// ✅ 好的命名
const currentDate = new Date();
const doubleValue = (value) => value * 2;
```

#### 1.2 可维护性（7分）
- [ ] **避免代码重复**（2分）
  - DRY 原则（Don't Repeat Yourself）
  - 提取公共函数
  - 使用工具函数库

- [ ] **适当的注释**（2分）
  - 复杂逻辑有注释说明
  - 不注释显而易见的代码
  - 注释说明"为什么"而非"做什么"
  - JSDoc/Docstring 完整

- [ ] **模块化设计**（3分）
  - 适当的文件拆分
  - 清晰的模块边界
  - 合理的依赖关系
  - 避免循环依赖

**检查方法：**
```bash
# 检查重复代码
npx jscpd src/

# 检查复杂度
npx eslint --ext .js,.ts src/ --rule 'complexity: [error, 10]'
```

#### 1.3 代码复杂度（5分）
- [ ] **圈复杂度 ≤10**（2分）
  - 减少 if/else 嵌套
  - 使用 early return
  - 提取复杂条件为函数

- [ ] **认知复杂度合理**（2分）
  - 逻辑易于理解
  - 避免过度抽象
  - 减少心理负担

- [ ] **性能合理**（1分）
  - 避免 O(n²) 以上算法（除非必要）
  - 注意内存泄漏
  - 合理使用缓存

**复杂度示例：**
```javascript
// ❌ 圈复杂度高（7）
function processData(data) {
  if (data) {
    if (data.type === 'A') {
      if (data.valid) {
        // ...
      } else {
        // ...
      }
    } else if (data.type === 'B') {
      // ...
    }
  }
}

// ✅ 圈复杂度低（3）
function processData(data) {
  if (!data) return;

  const handlers = {
    A: processTypeA,
    B: processTypeB
  };

  const handler = handlers[data.type];
  if (handler) handler(data);
}
```

---

### 2. 测试覆盖（15分）

#### 2.1 单元测试（7分）
- [ ] **核心逻辑有测试**（3分）
  - 所有公共函数/方法
  - 关键业务逻辑
  - 复杂算法

- [ ] **边界条件测试**（2分）
  - 空值/null/undefined
  - 空数组/空对象
  - 最大/最小值
  - 异常输入

- [ ] **测试覆盖率 ≥80%**（2分）
  - 语句覆盖率
  - 分支覆盖率
  - 函数覆盖率

**测试示例：**
```javascript
describe('calculateDiscount', () => {
  it('应该正确计算10%折扣', () => {
    expect(calculateDiscount(100, 0.1)).toBe(90);
  });

  it('应该处理0折扣', () => {
    expect(calculateDiscount(100, 0)).toBe(100);
  });

  it('应该处理100%折扣', () => {
    expect(calculateDiscount(100, 1)).toBe(0);
  });

  it('应该拒绝负数折扣', () => {
    expect(() => calculateDiscount(100, -0.1)).toThrow();
  });
});
```

#### 2.2 集成测试（5分）
- [ ] **API 端点测试**（2分）
  - 所有 REST 端点
  - 请求/响应验证
  - 状态码检查

- [ ] **组件集成测试**（2分）
  - 模块间交互
  - 数据流验证
  - 副作用检查

- [ ] **端到端测试（可选）**（1分）
  - 关键用户流程
  - UI 交互测试

**检查命令：**
```bash
# 运行测试
npm test

# 查看覆盖率
npm run test:coverage

# 集成测试
npm run test:integration
```

#### 2.3 错误处理测试（3分）
- [ ] **异常场景覆盖**（2分）
  - 网络错误
  - 超时处理
  - 资源不存在
  - 权限不足

- [ ] **错误信息清晰**（1分）
  - 有意义的错误消息
  - 包含上下文信息
  - 便于调试

---

### 3. 规范遵循（15分）

#### 3.1 编码规范（7分）
- [ ] **代码格式一致**（2分）
  - 使用 Prettier/ESLint
  - 遵循项目配置
  - 无格式警告

- [ ] **命名规范统一**（2分）
  - 变量：camelCase
  - 常量：UPPER_SNAKE_CASE
  - 类：PascalCase
  - 私有成员：_prefix

- [ ] **文件组织规范**（3分）
  - 遵循项目结构
  - 模块导入顺序
  - 文件命名规范

**检查命令：**
```bash
# Lint 检查
npm run lint

# 格式检查
npm run format:check

# 类型检查（TypeScript）
npm run type-check
```

#### 3.2 安全规范（5分）
- [ ] **无明显安全漏洞**（3分）
  - SQL 注入防护
  - XSS 防护
  - CSRF 防护
  - 输入验证

- [ ] **敏感信息处理**（2分）
  - 不硬编码密码/密钥
  - 不在日志中泄露敏感数据
  - 使用环境变量

**安全检查：**
```bash
# 依赖漏洞扫描
npm audit

# 代码安全扫描
npx snyk test
```

#### 3.3 文档规范（3分）
- [ ] **README 更新**（1分）
  - 新功能说明
  - API 变更记录

- [ ] **代码注释完整**（1分）
  - 公共 API 有文档
  - 复杂逻辑有说明

- [ ] **CHANGELOG 更新**（1分）
  - 记录变更内容
  - 遵循语义化版本

---

## 🎯 战略维度（50分）

### 4. 需求匹配（20分）

#### 4.1 功能完整性（10分）
- [ ] **核心需求实现**（5分）
  - 所有用户故事完成
  - 验收标准满足
  - 无功能遗漏

- [ ] **边界条件处理**（3分）
  - 异常情况考虑完整
  - 降级策略清晰
  - 错误提示友好

- [ ] **用户体验良好**（2分）
  - 响应及时
  - 操作流畅
  - 提示清晰

**验证方法：**
- 对照原始需求文档逐项检查
- 运行所有验收测试用例
- 手动测试关键流程

#### 4.2 非功能性需求（10分）
- [ ] **性能要求达标**（4分）
  - 响应时间 <200ms（API）
  - 首屏加载 <3s（前端）
  - 并发支持达标

- [ ] **可扩展性考虑**（3分）
  - 易于添加新功能
  - 配置灵活
  - 插件化设计（如适用）

- [ ] **兼容性保证**（3分）
  - 浏览器兼容（前端）
  - 版本向后兼容
  - API 版本管理

**性能测试：**
```bash
# API 性能测试
npm run perf:api

# 前端性能测试
npm run lighthouse
```

---

### 5. 架构一致（15分）

#### 5.1 设计模式（7分）
- [ ] **遵循现有模式**（4分）
  - 与现有代码风格一致
  - 使用项目约定的模式
  - 不引入不必要的复杂性

- [ ] **SOLID 原则**（3分）
  - 单一职责原则
  - 开闭原则
  - 依赖倒置原则

**示例：**
```javascript
// ✅ 符合单一职责原则
class UserRepository {
  async findById(id) { /* ... */ }
  async save(user) { /* ... */ }
}

class UserService {
  constructor(userRepo) {
    this.userRepo = userRepo;
  }

  async updateProfile(id, data) {
    const user = await this.userRepo.findById(id);
    user.update(data);
    await this.userRepo.save(user);
  }
}
```

#### 5.2 技术选型（5分）
- [ ] **技术栈一致**（3分）
  - 使用项目已有的技术
  - 不引入不必要的新依赖
  - 版本兼容

- [ ] **依赖管理合理**（2分）
  - 依赖数量合理
  - 依赖版本明确
  - 无过时依赖

**检查命令：**
```bash
# 检查过时依赖
npm outdated

# 检查依赖树
npm ls --depth=0
```

#### 5.3 数据流设计（3分）
- [ ] **数据流清晰**（2分）
  - 单向数据流
  - 状态管理规范
  - 避免副作用

- [ ] **API 设计合理**（1分）
  - RESTful 或 GraphQL 规范
  - 接口命名清晰
  - 版本控制

---

### 6. 风险评估（15分）

#### 6.1 技术风险（8分）
- [ ] **性能风险**（3分）
  - 无性能瓶颈
  - 资源使用合理
  - 可承受高负载

- [ ] **安全风险**（3分）
  - 无 OWASP Top 10 漏洞
  - 数据加密存储
  - 权限控制严格

- [ ] **可靠性风险**（2分）
  - 错误处理完善
  - 有重试机制
  - 日志记录完整

**风险评估：**
```
高风险：立即修复，否则拒绝合并
中风险：计划修复，可以合并但需跟踪
低风险：建议优化，可选修复
```

#### 6.2 维护风险（4分）
- [ ] **技术债务**（2分）
  - 无明显技术债务
  - TODO 标记合理
  - 临时方案有计划

- [ ] **文档完整**（2分）
  - 设计文档齐全
  - 部署文档清晰
  - 运维手册完整

#### 6.3 业务风险（3分）
- [ ] **数据一致性**（2分）
  - 事务处理正确
  - 并发控制完善
  - 数据迁移安全

- [ ] **兼容性影响**（1分）
  - 不破坏现有功能
  - API 变更有通知
  - 有回滚方案

---

## 📊 评分规则

### 评分计算
```
技术维度总分 = 代码质量(20) + 测试覆盖(15) + 规范遵循(15)
战略维度总分 = 需求匹配(20) + 架构一致(15) + 风险评估(15)
综合评分 = 技术维度总分 + 战略维度总分
```

### 决策规则
```
≥90分 且建议"通过"     → 直接确认通过 ✅
<80分 且建议"退回"     → 直接确认退回 ❌
80-89分 或建议"需讨论" → 仔细审阅后决策 ⚠️
```

### 建议措辞
```
【通过】：代码质量优秀，符合所有标准，建议合并
【退回】：存在严重问题（列出），需要重新开发
【需讨论】：整体良好但有顾虑（列出），需要团队讨论决策
```

---

## 🔧 使用工作流

### 步骤1：准备审查
```bash
# 拉取最新代码
git checkout feature-branch
git pull origin feature-branch

# 安装依赖
npm install

# 运行测试
npm test
```

### 步骤2：执行检查
```bash
# 代码格式
npm run lint

# 类型检查
npm run type-check

# 安全扫描
npm audit

# 性能测试
npm run perf
```

### 步骤3：Codex 审查
使用 Codex 进行深度审查，参考本清单

### 步骤4：生成报告
输出到 `.claude/review-report.md`

---

## 📝 报告模板

参考 `codex-prompt-template.md` 中的"模板4：代码质量审查"

---

**遵循此清单，确保代码审查的全面性和一致性！**
